# PromptOps

Product research platform that scrapes community posts (Reddit, HackerNews), analyzes them with Claude AI to extract insights (pain points, competitors, trends), and generates product specs.

## Quick Start

```bash
docker compose up -d              # PostgreSQL + Redis
cp .env.example .env              # Set ANTHROPIC_API_KEY
npm install
npm run build -w packages/shared  # Build shared types first
npx prisma db push --schema apps/api/prisma/schema.prisma
npm run dev:api                   # API on :3001 (includes BullMQ worker)
npm run dev:web                   # Frontend on :5173 (proxies /api to :3001)
```

## Architecture

```
promptops/                        # npm workspaces monorepo
├── packages/shared/              # @promptops/shared — types, enums, constants
├── apps/api/                     # Express 5 + Prisma + BullMQ
│   ├── prisma/schema.prisma      # 8 models (User, Project, Source, RawPost, Insight, InsightSource, Spec, ScrapeJob), 4 enums
│   └── src/
│       ├── routes/               # REST endpoints (auth, projects, sources, insights, specs)
│       ├── services/
│       │   ├── scraper/          # Reddit (JSON API), HackerNews (Firebase + Algolia)
│       │   ├── analysis/         # Claude-powered: pain-points, competition, prioritization
│       │   ├── generation/       # Spec generator (3 formats)
│       │   └── queue/            # BullMQ jobs + worker
│       ├── lib/                  # prisma, redis, auth (bcrypt+jwt), response helpers, error classes
│       ├── middleware/           # error-handler, rate-limiter, auth (JWT bearer)
│       └── utils/                # claude.ts (askClaude), logger.ts (pino)
└── apps/web/                     # React 19 + Vite + Tailwind v4
    └── src/
        ├── pages/                # Dashboard, ProjectDetail, Insights, Specs, Settings, Login, Register
        ├── components/           # auth/, dashboard/, insights/, specs/, sources/, ui/, layout/
        ├── hooks/                # useAuth, useProjects, useInsights, useSpecs, useSources, useAnalysis
        └── lib/api.ts            # Fetch wrapper for /api/v1/*
```

## Tech Stack

- **Runtime**: Node.js >= 20, ESM (`.js` extensions in imports)
- **API**: Express 5, Zod validation, Pino logging
- **DB**: PostgreSQL 16 via Prisma ORM (cuid IDs, cascade deletes)
- **Queue**: BullMQ on Redis 7, single `promptops` queue, concurrency 3
- **AI**: Anthropic SDK, model `claude-sonnet-4-5-20250929`, structured JSON output
- **Auth**: bcryptjs (12 rounds), jsonwebtoken (7d expiry), Bearer token auth
- **Frontend**: React 19, React Router v7, Tailwind CSS v4, Recharts
- **TypeScript**: Strict mode, `noUncheckedIndexedAccess`, `verbatimModuleSyntax`

## Key Conventions

### API

- All responses follow `ApiResponse<T>` shape: `{ data, error, meta }`
- Response helpers: `sendSuccess(res, data, meta?)`, `sendCreated(res, data)`
- Error classes: `AppError`, `NotFoundError`, `ValidationError`, `ConflictError`, `AuthError`
- Pagination: cursor-based with `?cursor=&limit=` params
- Routes validate input with Zod schemas before processing

### Auth & Multi-tenancy

- JWT Bearer tokens via `Authorization: Bearer <token>` header
- `authMiddleware` verifies token, sets `req.userId` on all protected routes
- Auth routes (`/api/v1/auth/*`) are public; all other routes require auth
- `User` model: id, email (unique), passwordHash, name, timestamps
- `Project.userId` foreign key — all data isolation flows through project ownership
- Sources, insights, specs filter through `project: { userId: req.userId }` in Prisma queries
- Frontend: `AuthProvider` context wraps app, stores token in localStorage, auto-validates on mount
- `ProtectedRoute` component redirects to `/login` if not authenticated
- `api.ts` client auto-attaches Bearer token and redirects to `/login` on 401

### Database

- IDs are cuid strings, generated by Prisma
- All parent→child relations use `onDelete: Cascade`
- `RawPost` deduplication: `@@unique([platform, externalId])` with upsert
- `Insight.severity` is Int (0-based), `Insight.confidence` is Float (0-1)
- `Source.config` and `Insight.metadata` are `Json?` fields

### Queue Jobs

- Three job types on the `promptops` queue: `scrape`, `analyze`, `generate`
- `scrape`: dispatches to platform-specific scraper, manages `ScrapeJob` lifecycle
- `analyze`: runs `extractPainPoints` → `analyzeCompetition` → `prioritizeInsights` sequentially
- `generate`: calls `generateSpec(projectId, specId)`, updates placeholder spec

### Claude Integration

- `askClaude(system, user, options)` in `utils/claude.ts` — returns string
- All analysis prompts request raw JSON arrays (no markdown fences)
- Fallback parsing strips ```json fences if Claude wraps its response
- Temperatures: analysis 0.2-0.3, generation 0.5

### Frontend

- Hooks pattern: `useState` + `useCallback` + `useEffect`, return `{ data, loading, error, refetch }`
- Mutation hooks (useAnalysis, useSpecGeneration) don't auto-fetch, return action functions
- UI components: `Card`, `Badge` (variants: default/success/warning/danger/info), `Button` (primary/secondary/danger/ghost), `Loading`
- API client at `lib/api.ts`: `api.get<T>()`, `api.post<T>()`, `api.patch<T>()`, `api.delete<T>()`

## API Endpoints

```
GET    /api/v1/health

POST   /api/v1/auth/register       # body: { email, password, name? } → { token, user }
POST   /api/v1/auth/login          # body: { email, password } → { token, user }
GET    /api/v1/auth/me             # current user (requires auth)

# All routes below require Authorization: Bearer <token>
GET    /api/v1/projects            # list (cursor pagination, filtered by userId)
POST   /api/v1/projects            # create
GET    /api/v1/projects/:id        # detail (includes sources, counts)
PATCH  /api/v1/projects/:id        # update
DELETE /api/v1/projects/:id        # delete
POST   /api/v1/projects/:id/analyze  # trigger AI analysis pipeline

GET    /api/v1/sources             # list (?projectId= filter, includes scrapeJobs + _count)
POST   /api/v1/sources             # create
GET    /api/v1/sources/:id         # detail
DELETE /api/v1/sources/:id         # delete
POST   /api/v1/sources/:id/scrape  # trigger scrape job
GET    /api/v1/sources/:id/jobs    # scrape job history

GET    /api/v1/insights            # list (?projectId=&type=&minSeverity=&tag=)
GET    /api/v1/insights/:id        # detail (includes insightSources + rawPosts)

GET    /api/v1/specs               # list (?projectId=)
POST   /api/v1/specs               # create
GET    /api/v1/specs/:id           # detail
PATCH  /api/v1/specs/:id           # update
DELETE /api/v1/specs/:id           # delete
POST   /api/v1/specs/generate      # AI spec generation (body: projectId, format, title?)
```

## Build & Lint

```bash
npm run build            # shared → api (tsc only, no web)
npm run build -w apps/web  # web (tsc + vite build)
npm run lint             # eslint
npm run format           # prettier --write
npm run format:check     # prettier --check
```

## Database Commands

```bash
npm run db:push -w apps/api       # push schema to DB (dev)
npm run db:migrate -w apps/api    # create migration
npm run db:generate -w apps/api   # regenerate Prisma client
npm run db:studio -w apps/api     # open Prisma Studio GUI
```

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DATABASE_URL` | yes | — | PostgreSQL connection string |
| `REDIS_URL` | no | `redis://localhost:6379` | Redis for BullMQ |
| `ANTHROPIC_API_KEY` | yes* | `''` | Claude API key (*required for analysis/generation) |
| `JWT_SECRET` | no | `dev-secret-change-in-production` | Secret for JWT signing |
| `PORT` | no | `3001` | API server port |
| `NODE_ENV` | no | `development` | Environment |
| `LOG_LEVEL` | no | `info` | Pino log level |

## Roadmap

- **Phase 1** (done): Monorepo, Prisma schema, Express CRUD routes, BullMQ infra, React shell
- **Phase 2** (done): Reddit + HN scrapers, Claude analysis pipeline, spec generation, queue worker routing, full frontend wiring
- **Phase 3** (done): UX — project creation form, navigation, job polling, toast notifications, error boundary, 404 page
- **Phase 4** (done): Tests — Vitest setup, 22 API tests + 39 web tests (61 total)
- **Phase 5** (done): Auth & Multi-tenancy — User model, JWT register/login, auth middleware, data isolation by userId, login/register pages, route guards
- **Phase 6** — Features Avancées: scheduled recurring scrapes, ProductHunt scraper, Redis caching layer, CSV/PDF export, insight editing UI, analysis history, dashboard analytics over time
- **Phase 7** — Déploiement & Production: Dockerfiles (API + web), docker-compose prod, GitHub Actions CI/CD, monitoring/metrics, security hardening, Prisma migrations workflow
